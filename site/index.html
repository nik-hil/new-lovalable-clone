<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft. Create. Code. — Next-Generation Web Design</title>
    <link rel="stylesheet" href="/site/style.css">
</head>
<body>
    <div class="container">
        <h1 class="hero-title">Craft extraordinary websites.<br>One thought. Infinite possibilities.</h1>
        <form id="prompt-form">
            <textarea name="prompt" id="prompt-input" class="prompt-input" rows="3" 
                placeholder="Describe your vision — a revolutionary fintech platform, an immersive portfolio experience, or a premium e-commerce destination" required></textarea>
            <button type="submit" id="generate-btn" class="submit-button">
                <span id="btn-text">Create</span>
                <span id="loading-spinner" class="spinner" style="display: none;">⏳</span>
            </button>
        </form>
        
        <div class="usage-tip" style="margin-top: 15px; padding: 12px; background-color: #f0f8ff; border-radius: 6px; font-size: 0.9em; color: #0066cc;">
            ✨ <strong>Pro tip:</strong> Refine your creation effortlessly. Simply describe what you envision — "elevate the aesthetics", "embrace minimalism", or "integrate advanced functionality"
        </div>
        
        <div id="prompt-history" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>Creative History</h3>
                <button id="new-website-btn" class="secondary-button" style="font-size: 0.9em;">Start New Project</button>
            </div>
            <div id="history-list" class="history-container"></div>
        </div>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="preview-container" style="display: none;">
            <div class="preview-header">
                <h3>Live Preview</h3>
                <div class="preview-actions">
                    <button id="refine-btn" class="secondary-button">Refine Experience</button>
                    <button id="download-btn" class="action-button">Export Project</button>
                    <a id="open-new-tab" href="#" target="_blank" class="submit-button">Launch Experience</a>
                </div>
            </div>
            <iframe id="preview-iframe" src="about:blank"></iframe>
        </div>
    </div>
    <script>
        let currentPreviewUrl = '';
        let promptHistory = [];
        let currentWebsiteId = null;

        // Load existing data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load existing project data
            loadExistingData();
            
            // Setup real-time synchronization
            setupRealTimeSync();
            
            // Handle the new project button
            const newProjectBtn = document.getElementById('newProjectBtn');
            if (newProjectBtn) {
                newProjectBtn.addEventListener('click', function() {
                    fetch('/api/reset', {method: 'POST'})
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Clear history display
                                const historySection = document.getElementById('history-section');
                                if (historySection) {
                                    historySection.remove();
                                }
                                // Clear localStorage
                                localStorage.removeItem('promptHistory');
                                localStorage.setItem('lastHistoryUpdate', Date.now().toString());
                                alert('Started new project! Previous history cleared.');
                            }
                        })
                        .catch(error => {
                            console.error('Error starting new project:', error);
                            alert('Error starting new project');
                        });
                });
            }

            const form = document.querySelector('form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    const formData = new FormData(form);
                    const prompt = formData.get('prompt');
                    if (prompt) {
                        // Update localStorage for real-time sync
                        updateHistoryInStorage(prompt);
                    }
                });
            }
        });

        function loadExistingData() {
            fetch('/api/history')
                .then(response => response.json())
                .then(data => {
                    console.log('Loaded history:', data);
                    if (data.success && data.history.length > 0) {
                        // Update UI with existing data
                        const historyHtml = data.history.map(item => 
                            `<div class="history-item">
                                <strong>${new Date(item.created_at).toLocaleString()}:</strong> 
                                ${item.prompt} (${item.prompt_type})
                            </div>`
                        ).join('');
                        
                        // Add a history section if it doesn't exist
                        let historySection = document.getElementById('history-section');
                        if (!historySection) {
                            historySection = document.createElement('div');
                            historySection.id = 'history-section';
                            historySection.innerHTML = '<h3>Prompt History</h3><div id="history-content"></div>';
                            document.body.appendChild(historySection);
                        }
                        document.getElementById('history-content').innerHTML = historyHtml;
                        
                        // Store in localStorage for real-time sync
                        localStorage.setItem('promptHistory', JSON.stringify(data.history));
                        localStorage.setItem('lastHistoryUpdate', Date.now().toString());
                    }
                })
                .catch(error => console.error('Error loading history:', error));
        }
        
        // Real-time sync between tabs
        function setupRealTimeSync() {
            // Listen for storage changes from other tabs
            window.addEventListener('storage', function(e) {
                if (e.key === 'lastHistoryUpdate') {
                    console.log('History updated in another tab, refreshing...');
                    loadExistingData();
                }
            });
            
            // Periodically check for updates (fallback)
            setInterval(loadExistingData, 10000); // Check every 10 seconds
        }
        
        // Update localStorage when new prompt is submitted
        function updateHistoryInStorage(prompt) {
            const timestamp = new Date().toISOString();
            const newItem = {
                prompt: prompt,
                prompt_type: 'refinement',
                created_at: timestamp
            };
            
            let history = [];
            try {
                const stored = localStorage.getItem('promptHistory');
                if (stored) history = JSON.parse(stored);
            } catch (e) {
                console.error('Error parsing stored history:', e);
            }
            
            history.unshift(newItem);
            localStorage.setItem('promptHistory', JSON.stringify(history));
            localStorage.setItem('lastHistoryUpdate', Date.now().toString());
        }

        document.getElementById('prompt-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const prompt = event.target.prompt.value.trim();
            if (!prompt) {
                showError('Please enter a prompt to generate your website.');
                return;
            }
            
            // Add to history before generating
            addToHistory(prompt);
            
            // Show loading state
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            
            generateBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `prompt=${encodeURIComponent(prompt)}`
                });
                
                const result = await response.json();
                
                if (result.preview_url) {
                    currentPreviewUrl = result.preview_url;
                    document.getElementById('preview-iframe').src = result.preview_url;
                    
                    // Fix: Use the full URL for new tab instead of relative path
                    const newTabUrl = result.new_tab_url || result.preview_url;
                    document.getElementById('open-new-tab').href = newTabUrl;
                    
                    document.getElementById('preview-container').style.display = 'block';
                    
                    // Clear the text area for next prompt
                    event.target.prompt.value = '';
                    event.target.prompt.placeholder = 'Elevate your creation — "embrace minimalism", "amplify visual impact", "integrate seamless interactions"...';
                    
                    // Scroll to preview
                    document.getElementById('preview-container').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                } else {
                    showError(result.error || 'Something extraordinary went wrong.');
                }
            } catch (error) {
                showError('Connection interrupted. Please reconnect and continue creating.');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        });
        
        document.getElementById('refine-btn').addEventListener('click', function() {
            const promptInput = document.querySelector('.prompt-input');
            const refineContainer = document.getElementById('refine-container');
            
            // Show/hide refine section
            if (refineContainer && refineContainer.style.display === 'none') {
                refineContainer.style.display = 'block';
                this.textContent = '✨ Hide Refine';
            } else {
                // If no refine container, just focus on main input for refinement
                promptInput.focus();
                promptInput.placeholder = 'Enter refinements like "make it more modern", "change colors to blue", "add a contact form"...';
                
                // Scroll to input
                promptInput.scrollIntoView({ behavior: 'smooth' });
            }
        });

        document.getElementById('download-btn').addEventListener('click', async function() {
            if (!currentPreviewUrl) {
                showError('Please craft your masterpiece first before exporting.');
                return;
            }

            try {
                const response = await fetch('/download-zip', {
                    method: 'GET',
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'website.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showError('Export interrupted. Please try your export again.');
                }
            } catch (error) {
                showError('Connection interrupted. Please reconnect and continue creating.');
            }
        });
        
        // New Website button event listener
        document.getElementById('new-website-btn').addEventListener('click', async function() {
            try {
                await fetch('/api/reset');
                
                // Reset client state
                currentPreviewUrl = '';
                promptHistory = [];
                currentWebsiteId = null;
                
                // Hide preview and history
                document.getElementById('preview-container').style.display = 'none';
                document.getElementById('prompt-history').style.display = 'none';
                
                // Reset input
                const promptInput = document.getElementById('prompt-input');
                promptInput.value = '';
                promptInput.placeholder = 'Describe your vision — a revolutionary fintech platform, an immersive portfolio experience, or a premium e-commerce destination';
                
                // Clear any error messages
                document.getElementById('error-message').style.display = 'none';
                
            } catch (error) {
                console.error('Error resetting session:', error);
            }
        });
        
        function addToHistory(prompt) {
            promptHistory.push({
                text: prompt,
                timestamp: new Date().toLocaleString()
            });
            
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const historyContainer = document.getElementById('prompt-history');
            const historyList = document.getElementById('history-list');
            
            if (promptHistory.length === 0) {
                historyContainer.style.display = 'none';
                return;
            }
            
            historyContainer.style.display = 'block';
            historyList.innerHTML = '';
            
            promptHistory.forEach((entry, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-number">${index + 1}.</div>
                    <div class="history-content">
                        <div class="history-text">${entry.text}</div>
                        <div class="history-time">${entry.timestamp}</div>
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>