<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Craft. Create. Code. ‚Äî Next-Generation Web Design</title>
    <link rel="stylesheet" href="/site/style.css">
</head>
<body>
    <div class="container">
        <h1 class="hero-title">Craft extraordinary websites.<br>One thought. Infinite possibilities.</h1>
        <form id="prompt-form">
            <textarea name="prompt" id="prompt-input" class="prompt-input" rows="3" 
                placeholder="Describe your vision ‚Äî a revolutionary fintech platform, an immersive portfolio experience, or a premium e-commerce destination" required></textarea>
            <button type="submit" id="generate-btn" class="submit-button">
                <span id="btn-text">Create</span>
                <span id="loading-spinner" class="spinner" style="display: none;">‚åõ</span>
            </button>
        </form>
        
        <div class="usage-tip" style="margin-top: 15px; padding: 12px; background-color: #f0f8ff; border-radius: 6px; font-size: 0.9em; color: #0066cc;">
            ‚ú® <strong>Pro tip:</strong> Create full-stack applications! For data-driven sites (e.g., "flower shop with orders", "blog with posts", "booking system"), I'll generate complete Flask backends with MySQL databases. For refinements, simply describe your vision ‚Äî "elevate the aesthetics", "embrace minimalism", or "add new features"
        </div>
        
        <div style="display: flex; justify-content: center; margin-top: 15px;">
            <button id="new-website-btn" class="secondary-button" style="font-size: 0.9em;">üóëÔ∏è Clear All & Start New</button>
        </div>
        
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="preview-container" style="display: none;">
            <div class="preview-header">
                <h3>Live Preview</h3>
                <div class="preview-actions">
                    <button id="refine-btn" class="secondary-button">Refine Experience</button>
                    <button id="download-btn" class="action-button">Export Project</button>
                    <a id="open-new-tab" href="#" target="_blank" class="submit-button">Launch Experience</a>
                </div>
            </div>
            <iframe id="preview-iframe" src="about:blank"></iframe>
        </div>
    </div>
    <script>
        let currentPreviewUrl = '';

        // Load existing data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Setup form handling
            const form = document.querySelector('form');
            if (form) {
                // Form is already handled by the main submit listener below
                console.log('Form initialized');
            }
        });

        document.getElementById('prompt-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            
            const prompt = event.target.prompt.value.trim();
            if (!prompt) {
                showError('Please enter a prompt to generate your website.');
                return;
            }
            

            
            // Show loading state
            const generateBtn = document.getElementById('generate-btn');
            const btnText = document.getElementById('btn-text');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('error-message');
            
            generateBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'inline';
            errorMessage.style.display = 'none';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `prompt=${encodeURIComponent(prompt)}`
                });
                
                const result = await response.json();
                
                if (result.preview_url) {
                    currentPreviewUrl = result.preview_url;
                    document.getElementById('preview-iframe').src = result.preview_url;
                    
                    // Fix: Use the full URL for new tab instead of relative path
                    const newTabUrl = result.new_tab_url || result.preview_url;
                    document.getElementById('open-new-tab').href = newTabUrl;
                    
                    document.getElementById('preview-container').style.display = 'block';
                    
                    // Show information about generated files
                    if (result.files_generated) {
                        const hasBackend = result.files_generated.some(file => 
                            file.endsWith('.py') || file.endsWith('.sql')
                        );
                        
                        if (hasBackend) {
                            // Add a small notice for full-stack applications
                            const existingNotice = document.getElementById('backend-notice');
                            if (existingNotice) existingNotice.remove();
                            
                            const notice = document.createElement('div');
                            notice.id = 'backend-notice';
                            notice.innerHTML = `
                                <div style="background-color: #e8f5e8; border: 1px solid #4caf50; border-radius: 6px; padding: 10px; margin: 10px 0; font-size: 0.9em; color: #2e7d32;">
                                    üöÄ <strong>Full-stack application generated!</strong> 
                                    Created ${result.files_generated.length} files including backend API and database schema.
                                    <br><small>Files: ${result.files_generated.join(', ')}</small>
                                </div>
                            `;
                            document.getElementById('preview-container').appendChild(notice);
                        }
                    }
                    
                    // Clear the text area for next prompt
                    event.target.prompt.value = '';
                    event.target.prompt.placeholder = 'Elevate your creation ‚Äî "embrace minimalism", "amplify visual impact", "integrate seamless interactions"...';
                    
                    // Scroll to preview
                    document.getElementById('preview-container').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                } else {
                    showError(result.error || 'Something extraordinary went wrong.');
                }
            } catch (error) {
                showError('Connection interrupted. Please reconnect and continue creating.');
            } finally {
                // Reset button state
                generateBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            }
        });
        
        document.getElementById('refine-btn').addEventListener('click', function() {
            const promptInput = document.querySelector('.prompt-input');
            const refineContainer = document.getElementById('refine-container');
            
            // Show/hide refine section
            if (refineContainer && refineContainer.style.display === 'none') {
                refineContainer.style.display = 'block';
                this.textContent = '‚ú® Hide Refine';
            } else {
                // If no refine container, just focus on main input for refinement
                promptInput.focus();
                promptInput.placeholder = 'Enter refinements like "make it more modern", "change colors to blue", "add a contact form"...';
                
                // Scroll to input
                promptInput.scrollIntoView({ behavior: 'smooth' });
            }
        });

        document.getElementById('download-btn').addEventListener('click', async function() {
            if (!currentPreviewUrl) {
                showError('Please craft your masterpiece first before exporting.');
                return;
            }

            try {
                const response = await fetch('/download-zip', {
                    method: 'GET',
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'website.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    showError('Export interrupted. Please try your export again.');
                }
            } catch (error) {
                showError('Connection interrupted. Please reconnect and continue creating.');
            }
        });
        
        // New Website button event listener
        document.getElementById('new-website-btn').addEventListener('click', async function() {
            if (!confirm('This will clear all generated files and start a new project. Are you sure?')) {
                return;
            }
            
            try {
                // Call the clear-all endpoint to properly clear everything
                const response = await fetch('/api/clear-all', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Reset client state
                    currentPreviewUrl = '';
                    
                    // Hide preview
                    document.getElementById('preview-container').style.display = 'none';
                    
                    // Reset input
                    const promptInput = document.getElementById('prompt-input');
                    promptInput.value = '';
                    promptInput.placeholder = 'Describe your vision ‚Äî a revolutionary fintech platform, an immersive portfolio experience, or a premium e-commerce destination';
                    
                    // Clear any error messages
                    document.getElementById('error-message').style.display = 'none';
                    
                    // Clear any cached data
                    localStorage.clear();
                    
                    alert('‚úÖ Project cleared successfully! All files and data removed.');
                } else {
                    alert('‚ùå Error clearing project: ' + (result.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('Error clearing project:', error);
                alert('‚ùå Error clearing project: ' + error.message);
            }
        });
        

        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>